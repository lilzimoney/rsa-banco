<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BBVA - Registro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'bbva-blue': '#1973B8',
            'bbva-dark-blue': '#043263',
            'bbva-light-blue': '#5BBAD5'
          }
        }
      }
    };
  </script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
</head>

<body class="bg-gray-50 min-h-screen">

  <!-- Header -->
  <header class="bg-white shadow-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <div class="flex items-center">
          <svg class="h-8 w-auto" viewBox="0 0 120 40" fill="none">
            <text x="0" y="28" font-family="Arial, sans-serif" font-size="24" font-weight="bold"
              fill="#1973B8">BBVA</text>
          </svg>
        </div>
        <div>
          <a href="#" class="text-bbva-blue hover:text-bbva-dark-blue text-sm font-medium">Ir a BBVA Perú</a>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
      <!-- Formulario de Registro -->
      <div class="bg-white rounded-lg shadow-lg p-8 max-w-md mx-auto lg:mx-0">
        <h1 class="text-3xl font-bold text-bbva-dark-blue mb-2">Afíliate</h1>
        <p class="text-gray-600 mb-6">Completa tus datos para afiliarte</p>

        <form class="space-y-4" id="registerForm">
          <!-- Tipo Documento -->
          <div>
            <label class="block text-sm text-gray-600 mb-1">Tipo de documento</label>
            <div class="relative">
              <select
                class="w-full px-3 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-bbva-blue focus:border-transparent appearance-none bg-white">
                <option>DNI</option>
                <option>CE</option>
                <option>Pasaporte</option>
              </select>
              <i
                class="fas fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
            </div>
          </div>

          <!-- Número de Documento -->
          <div>
            <input type="text" placeholder="Número de documento" id="documentNumber" maxlength="12"
              class="w-full px-3 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-bbva-blue focus:border-transparent" />
          </div>

          <!-- Nombre Completo -->
          <div>
            <input type="text" placeholder="Nombre completo" id="fullName"
              class="w-full px-3 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-bbva-blue focus:border-transparent" />
          </div>

          <!-- Contraseña -->
          <div class="relative">
            <input type="password" placeholder="Contraseña" id="password"
              class="w-full px-3 py-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-bbva-blue focus:border-transparent pr-10" />
            <button type="button"
              class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
              <i class="fas fa-eye"></i>
            </button>
          </div>

          <!-- Botón -->
          <div class="pt-4">
            <button type="submit"
              class="w-full bg-bbva-dark-blue hover:bg-blue-900 text-white font-medium py-3 px-6 rounded-md transition duration-200">
              Registrar
            </button>
          </div>
        </form>
      </div>

      <!-- Info derecha -->
      <div class="bg-white rounded-lg shadow-lg p-8 max-w-md mx-auto lg:mx-0 text-center">
        <h2 class="text-2xl font-bold text-bbva-dark-blue mb-4">Beneficios de nuestros canales digitales</h2>
        <ul class="text-gray-600 mb-6 text-left space-y-2">
          <li class="flex items-start"><i class="fas fa-check text-bbva-blue mr-2 mt-1"></i> Realiza transferencias
            desde cualquier lugar</li>
          <li class="flex items-start"><i class="fas fa-check text-bbva-blue mr-2 mt-1"></i> Consulta tus movimientos en
            tiempo real</li>
          <li class="flex items-start"><i class="fas fa-check text-bbva-blue mr-2 mt-1"></i> Recibe notificaciones</li>
          <li class="flex items-start"><i class="fas fa-check text-bbva-blue mr-2 mt-1"></i> Configura alertas
            personalizadas</li>
        </ul>
      </div>
    </div>
  </main>

  <script>
    // Mostrar/ocultar contraseña
    document.querySelector('.fa-eye').addEventListener('click', function () {
      const passwordInput = document.getElementById('password');
      const icon = this;

      if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
      } else {
        passwordInput.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
      }
    });

    // Encriptar y enviar
    document.addEventListener('DOMContentLoaded', async function () {
      const res = await fetch('http://localhost:3000/api/generate-pk');
      const { n, e } = await res.json();
      const n_num = parseInt(n);
      const e_num = parseInt(e);

      function encryptRSA(message, n_str, e_str) {
        const n = BigInt(n_str);
        const e = BigInt(e_str);
        const encrypted = [];

        for (let i = 0; i < message.length; i++) {
          const m = BigInt(message.charCodeAt(i));
          if (m >= n) throw new Error(`Carácter '${message[i]}' (ASCII=${m}) no puede cifrarse con n=${n}`);
          const c = modPow(m, e, n);
          encrypted.push(c.toString());
        }

        return encrypted.length === 1 ? encrypted[0] : encrypted;
      }

      function modPow(base, exponent, modulus) {
        if (modulus === 1n) return 0n;
        let result = 1n;
        base %= modulus;
        while (exponent > 0n) {
          if (exponent % 2n === 1n) result = (result * base) % modulus;
          exponent >>= 1n;
          base = (base * base) % modulus;
        }
        return result;
      }

      document.getElementById('registerForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        const secretKey = crypto.getRandomValues(new Uint8Array(32)).reduce((acc, val) => acc + String.fromCharCode(val % 94 + 33), '');
        const rsaEncryptedKey = encryptRSA(secretKey, n_num, e_num);
        const formatRsa = Array.isArray(rsaEncryptedKey) ? rsaEncryptedKey.join(',') : rsaEncryptedKey;

        const formData = {
          docType: this.querySelector('select').value,
          ndoc: document.getElementById('documentNumber').value,
          fullName: document.getElementById('fullName').value,
          password: document.getElementById('password').value
        };

        const iv = CryptoJS.lib.WordArray.random(16);
        const key = CryptoJS.enc.Utf8.parse(secretKey);

        const encrypted = CryptoJS.AES.encrypt(JSON.stringify(formData), key, {
          iv: iv,
          mode: CryptoJS.mode.CBC,
          padding: CryptoJS.pad.Pkcs7
        });

        const encryptedData = iv.toString(CryptoJS.enc.Hex) + ':' + encrypted.toString();

        const resp = await fetch('http://localhost:3000/api/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ encryptedData, secretKeycl: formatRsa })
        });

        const result = await resp.json();
        if (!result.success) {
          alert('Error en el registro');
          return;
        }

        window.location.href = 'login.html';
      });
    });
  </script>
</body>

</html>